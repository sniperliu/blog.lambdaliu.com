{:title "When Ansible & Docker in Digital Ocean - Round 2"
 :layout :post
 :tags ["ansible" "docker" "digital ocean" "cloud computing"]}

## Problem

To setup a blog server with nginx docker container to serve static html generated by [Cryogen](http://cryogenweb.org/) in digital ocean, with proper security and server configuration.

## Goal

- Declarative machine configuration
- Dockerized containers
- Easy to migrate to other VPS
- Be lazy

For my later clojure web application
- Easy to scale horizontally
- Easy to setup and maintain a cluster (Ya, Docker Swarm!!!)

## Round 2 - Automate the site build and configure magically

After read the [this article](http://nathanleclaire.com/blog/2015/11/10/using-ansible-with-docker-machine-to-bootstrap-host-nodes/), I found docker-machine + ansible will be the saver, which could archive my goal. It use some tricks I think to run the ansible from docker container against host, which is use the host network stack.

Anyway just do it!!

1. After sign up digital ocean, generate new API token with read/write access, keep it to yourself.

2. Make sure you installed docker-machine on your desktop/laptop.

3. Download the Dockerfile, which contain the ansible & playbooks from [repository](https://github.com/sniperliu/blog.lambdaliu.com/infra)
```shell
$ cd PATH # infra folder
# RUN startvm.sh which contains below command to start a docker machine in ocean
$ docker-machine create --driver digitalocean \
       	         --digitalocean-access-token=$DIGITALOCEAN_ACCESS_TOKEN \
	         --digitalocean-image=ubuntu-15-10-x64 \
	         --digitalocean-region=sgp1 \
	         --digitalocean-size=512mb \
	         ansible-sandbox
```


