{:title "When Ansible & Docker in Digital Ocean"
 :layout :post
 :tags ["ansible" "docker" "digital ocean" "cloud computing"]}

## Problem

To setup a blog server with nginx docker container to serve static html generated by [Cryogen](http://cryogenweb.org/) in digital ocean, with proper security and server configuration.

## Goal

- Declarative machine configuration
- Dockerized containers
- Easy to migrate to other VPS
- Be lazy

For my later clojure web application
- Easy to scale horizontally
- Easy to setup and maintain a cluster (Ya, Docker Swarm!!!)

## Round 1 - Do everything manually

I read [this post](http://blog.th4t.net/category/a-server-with-docker.html) and also [this](http://coderunner.io/hello-blog-an-advanced-setup-of-ghost-and-docker-made-simple/), and signed up Digital Ocean, setup a workable server with below steps. Nothing quite interesting.
1. setup a 2-phase authentication with digital ocean
2. generate the ssh key and add pub key to digital ocean from web page
```shell
# Be carefull and choose a name properly (like ~/.ssh/id_rsa_do)
# and avoid overwrite exising key file
$ ssh-gen
```
3. create the droplet, remember to choose ssh option
4. edit the config file in client side, your laptop/desktop
```shell
$vi ~/.ssh/config
host HOSTNAME
    HostName HOST_IP # IP of your droplet
    Port HOST_SSH_PORT # default is 22
    IdentityFile ~/.ssh/SSH_PRIVATE_KEY # the name you provide in step 2
    User root # login user
```
5. ssh your new droplet and keep the TERM open and connected till all steps finished
```shell
$ ssh HOSTNAME # which provided in step 4
...
root@HOSTNAME:~#
# Now we have a server ready!!!!! Yey!
```
6. cleanup and furnish the house
```shell
# security setup, only for personal site
# change the default ssh port
# disable ssh password login
# no root login > .ignore_fornow
root@HOSTNAME:~#vi /etc/ssh/sshd_config
Port 5060
PasswordAuthentication no
ChallengeResponseAuthentication no
root@HOSTNAME:~#service ssh restart
# clearn the login system information
...
# Start to furnish our house
root@HOSTNAME:~#apt-get update
# install your favorite admin tools, like htop
#configure the firewall (ufw)
root@HOSTNAME:~#ufw allow 5060 # for OpenSSH
root@HOSTNAME:~#ufw allow 80 # for HTTP
root@HOSTNAME:~#ufw enable
root@HOSTNAME:~#ufw status
...
```
7. try the new configuration and setup, please open another TERM console, and keep current open and connected
```shell
$ ssh HOSTNAME
# You should see
root@HOSTNAME:~#
root@HOSTNAME:~#ufw status
... # you should see ssh port, http enabled, no other port allowed
# Otherwise something maybe wrong with step 6
```
8. follow the nice document of Docker, install [Docker Engine](https://docs.docker.com/engine/installation/linux/ubuntulinux/) & [Docker Compose](https://docs.docker.com/compose/install/)


## Round 2 - Automate the site build and configure magically

Coming Soon ...

## Put the container on the docker in ocean


```
.
+-- docker-compose.yml
+-- config
|   +-- Dockerfile
|   +-- nginx.conf
+-- content
|   +-- www
|   	+-- index.html
|	+-- blog
|	    â‹®
+-- data
```

## Reference
[Repo]()

[A Server With Docker](http://blog.th4t.net/category/a-server-with-docker.html)

[An advanced setup of Ghost and Docker made simple](http://coderunner.io/hello-blog-an-advanced-setup-of-ghost-and-docker-made-simple/)

[Using Ansible with Docker Machine to Bootstrap Host Nodes](http://nathanleclaire.com/blog/2015/11/10/using-ansible-with-docker-machine-to-bootstrap-host-nodes/) form Nathan Leclarire

